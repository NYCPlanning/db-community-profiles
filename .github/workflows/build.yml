name: Build Community Profiles
on:
  workflow_dispatch:
jobs:
  Build:
    runs-on: ubuntu-20.04
    env:
      RECIPE_ENGINE: ${{ secrets.RECIPE_ENGINE }}
      EDM_DATA: ${{ secrets.EDM_DATA }}
      API_TOKEN: ${{ secrets.API_TOKEN }}
      BUILD_ENGINE: ${{ secrets.BUILD_ENGINE }}
      CENSUS_API_KEY: ${{ secrets.CENSUS_API_KEY }}
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-python@v2
      with:
        python-version: 3.9
    
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y postgresql-client
        pip install -r requirements.txt

    - name: Build
      id: build
      run: |
        echo ::set-output name=date::$(date)
        ./build.sh all

    - name: Upload artifacts
      uses: actions/upload-artifact@v1
      with:
        name: output
        path: output/

    - name: Commit output
      uses: EndBug/add-and-commit@v6
      with:
        author_name: GitHub Action
        author_email: action@github.com
        message: "ðŸŽ‰ Rerun and Update ${{steps.build.outputs.date}}"
        add: output/

    - name: Create Issue to Publish
      uses: nashmaniac/create-issue-action@v1.1
      with:
        title: |
          [publish] Outputs from ${{steps.build.outputs.date}}
        token: ${{secrets.GITHUB_TOKEN}}
        assignees: mgraber, SPTKL, AmandaDoyle
        body: |
          ## ðŸŽ‰ There is updated Community Profiles data from ${{steps.build.outputs.date}}
          ## Next Steps:
          If you have manually checked above files and they seem to be ok, comment `[publish]` under this issue. 
          This would allow github actions to publish files to DigitalOcean, where Labs will pull files for download. 
          Feel free to close this issue once it's all complete. Thanks!
